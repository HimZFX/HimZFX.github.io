<canvas id="bgCanvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-1;pointer-events:none;"></canvas>

<script>
window.BG_System = (function() {
    // 1. 内部状态
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let isRunning = false;
    let animationFrameId = null;
    let currentEffect = null; // 当前插入的卡带

    // 2. 智能路由与开关状态
    const path = window.location.pathname;
    const isHomePage = path === '/' || /^\/[a-z]{2}\/$/.test(path);
    let userEnabled = isHomePage; // 默认只有首页开启

    // 3. UI 按钮
    const btn = document.createElement('button');
    btn.style.cssText = `position:fixed;bottom:20px;left:20px;z-index:999;background:transparent;border:none;cursor:pointer;opacity:0.6;transition:all 0.3s;padding:5px;`;
    const iconOn = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5c3.2 0 5.2-2.3 5.2-2.3 0-3.2-2.3-5.2-2.3-5.2S12 5.5 12 2Z"/></svg>`;
    const iconOff = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 6.44a4 4 0 0 1 2.28-2.68"></path><path d="M12.6 3.35A10 10 0 0 1 12 2c3.2 0 5.2 2.3 5.2 2.3a10.36 10.36 0 0 1 1.7 1.3"></path><path d="M20.47 16.5a10 10 0 0 1-3.27 3.7"></path><path d="M10 19.3a10 10 0 0 1-5.3-2.8"></path><circle cx="12" cy="12" r="10"></circle></svg>`;
    
    function updateBtn() {
        btn.innerHTML = userEnabled ? iconOn : iconOff;
        btn.style.opacity = userEnabled ? '1' : '0.6';
    }
    updateBtn();
    
    btn.onclick = () => {
        userEnabled = !userEnabled;
        updateBtn();
        if (userEnabled) start(); else stop();
    };
    btn.onmouseenter = () => btn.style.transform = 'scale(1.1)';
    btn.onmouseleave = () => btn.style.transform = 'scale(1)';
    document.body.appendChild(btn);

    // 4. 核心功能
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        if (currentEffect && currentEffect.onResize) currentEffect.onResize(width, height);
    }

    function getIsDark() {
        try {
            const rgb = window.getComputedStyle(document.body).backgroundColor.match(/\d+/g);
            if (rgb) {
                return ((parseInt(rgb[0])*299 + parseInt(rgb[1])*587 + parseInt(rgb[2])*114)/1000) < 128;
            }
        } catch(e) {}
        return document.body.classList.contains('dark');
    }

    function loop() {
        if (!userEnabled || !currentEffect) return;
        
        ctx.clearRect(0, 0, width, height);
        const isDark = getIsDark();
        
        // 调用卡带的逻辑
        currentEffect.onUpdate(isDark);
        currentEffect.onDraw(ctx, width, height, isDark);
        
        animationFrameId = requestAnimationFrame(loop);
    }

    function start() {
        if (isRunning) return;
        isRunning = true;
        resize();
        loop();
    }

    function stop() {
        isRunning = false;
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        ctx.clearRect(0, 0, width, height);
    }

    window.addEventListener('resize', resize);
    resize();

    // 5. 对外接口：插入卡带
    return {
        loadCassette: function(effect) {
            currentEffect = effect;
            if (currentEffect.onInit) currentEffect.onInit(width, height);
            // 只有当用户允许（且在首页）时才自动启动
            if (userEnabled) start();
        }
    };
})();
</script>