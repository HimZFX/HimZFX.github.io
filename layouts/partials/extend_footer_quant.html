<script>
(function() {
    const canvas = document.getElementById('bgCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    let width, height;
    let particles = [];
    
    // --- âš™ï¸ åœºå‚æ•° ---
    const PARTICLE_COUNT = 400;   // ç²’å­æ•°é‡
    const GRID_SIZE = 20;         // åœºçš„åˆ†è¾¨ç‡
    const ZOOM = 0.005;           // åœºçš„ç–å¯†ç¨‹åº¦
    const CURVE_STRENGTH = 20;    // å¼¯æ›²ç¨‹åº¦
    const SPEED_MULT = 1.5;       // é€Ÿåº¦å€ç‡

    // --- ğŸ¨ é¢œè‰²æ–¹æ¡ˆ ---
    const colors = {
        // é»‘å¤œï¼šç”µå…‰è“ -> ç»¿ (Cyberpunk)
        dark: { r: 0, g: 255, b: 200, alpha: 0.5 }, 
        // ç™½å¤©ï¼šé“…ç¬”ç° (Sketch)
        light: { r: 50, g: 60, b: 70, alpha: 0.15 } 
    };

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        initParticles();
    }

    class Particle {
        constructor() {
            this.reset();
        }

        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.history = []; // è®°å½•ä¸€å°æ®µè½¨è¿¹
        }

        update() {
            // è®¡ç®—å½“å‰ä½ç½®çš„åœºå‘é‡ (ç®€å•çš„ä¸‰è§’åœºï¼Œä¸éœ€è¦ Perlin Noise åº“)
            // angle = cos(x) + sin(y) çš„å˜ç§ï¼Œåˆ¶é€ å¤æ‚çš„æ¼©æ¶¡
            const angle = (Math.cos(this.x * ZOOM) + Math.sin(this.y * ZOOM)) * CURVE_STRENGTH;
            
            this.vx = Math.cos(angle) * SPEED_MULT;
            this.vy = Math.sin(angle) * SPEED_MULT;

            this.x += this.vx;
            this.y += this.vy;

            // è®°å½•è½¨è¿¹
            this.history.push({x: this.x, y: this.y});
            if (this.history.length > 10) this.history.shift();

            // è¾¹ç•Œæ£€æŸ¥ï¼šé£å‡ºå»äº†å°±é‡ç”Ÿ
            if (this.x < 0 || this.x > width || this.y < 0 || this.y > height) {
                this.reset();
            }
        }

        draw(isDark) {
            if (this.history.length < 2) return;
            
            ctx.beginPath();
            ctx.moveTo(this.history[0].x, this.history[0].y);
            for (let i = 1; i < this.history.length; i++) {
                ctx.lineTo(this.history[i].x, this.history[i].y);
            }
            
            if (isDark) {
                ctx.strokeStyle = `rgba(${colors.dark.r}, ${colors.dark.g}, ${colors.dark.b}, ${Math.random()*0.5})`;
                ctx.lineWidth = 1.5;
            } else {
                ctx.strokeStyle = `rgba(${colors.light.r}, ${colors.light.g}, ${colors.light.b}, ${colors.light.alpha})`;
                ctx.lineWidth = 1; // ç™½å¤©çº¿ç»†ä¸€ç‚¹ï¼Œåƒç´ æ
            }
            ctx.stroke();
        }
    }

    function initParticles() {
        particles = [];
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            particles.push(new Particle());
        }
    }

    function animate() {
        // 1. å…‰çº¿ä¼ æ„Ÿå™¨
        let isDark = false;
        try {
            const bgColor = window.getComputedStyle(document.body).backgroundColor;
            const rgb = bgColor.match(/\d+/g);
            if (rgb) {
                const brightness = (parseInt(rgb[0])*299 + parseInt(rgb[1])*587 + parseInt(rgb[2])*114)/1000;
                isDark = brightness < 128;
            }
        } catch(e) { isDark = document.body.classList.contains('dark'); }

        // 2. æ‹–å°¾æ§åˆ¶
        // æˆ‘ä»¬ä¸å®Œå…¨æ¸…ç©ºç”»å¸ƒï¼Œè€Œæ˜¯è¦†ç›–ä¸€å±‚å¸¦é€æ˜åº¦çš„çŸ©å½¢ï¼Œå½¢æˆé•¿å°¾è¿¹
        if (isDark) {
            ctx.fillStyle = 'rgba(5, 5, 5, 0.1)'; // é»‘å¤œæ¶ˆæ•£å¾—å¿«ä¸€ç‚¹
        } else {
            ctx.fillStyle = 'rgba(245, 245, 247, 0.2)'; // ç™½å¤©æ¶ˆæ•£å¾—æ…¢ä¸€ç‚¹ï¼Œç•™ç—•æ›´å¤š
        }
        ctx.fillRect(0, 0, width, height);

        // 3. ç»˜åˆ¶
        for (let p of particles) {
            p.update();
            p.draw(isDark);
        }

        requestAnimationFrame(animate);
    }

    window.addEventListener('resize', resize);
    resize();
    animate();
})();
</script>