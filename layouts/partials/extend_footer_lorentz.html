<script>
(function() {
    const canvas = document.getElementById('bgCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    let width, height;
    
    // --- âš™ï¸ æ··æ²Œå‚æ•° ---
    // ç»å…¸æ´›ä¼¦å…¹å‚æ•°
    const sigma = 10;
    const rho = 28;
    const beta = 8/3;
    const dt = 0.008;      // æ—¶é—´æ­¥é•¿ (è¶Šå°è¶Šå¹³æ»‘)
    const SCALE = 12;      // ç¼©æ”¾å¤§å°
    const SPEED = 2;       // ç»˜åˆ¶é€Ÿåº¦ (æ¯å¸§ç”»å‡ ä¸ªç‚¹)
    
    // 3D æ—‹è½¬å‚æ•°
    let angle = 0; 
    
    // è½¨è¿¹ç‚¹é›†
    let points = [];
    // å½“å‰åæ ‡
    let x = 0.1, y = 0, z = 0;

    // --- ğŸ¨ é¢œè‰²æ–¹æ¡ˆ ---
    const colors = {
        dark: { hueStart: 180, hueEnd: 320, alpha: 0.8 }, // é’ -> æ´‹çº¢
        light: { hueStart: 240, hueEnd: 340, alpha: 0.5 } // æ·±è“ -> æ·±ç´« (å¢¨æ°´æ„Ÿ)
    };

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        // çª—å£å¤§å°æ”¹å˜ä¸é‡ç½®è½¨è¿¹ï¼Œä¼šæœ‰æœ‰è¶£çš„é”™ä½è‰ºæœ¯æ„Ÿ
    }

    function animate() {
        // 1. æ‹–å°¾æ•ˆæœ (å…³é”®ï¼)
        // ä¸åŒäºä¸‰ä½“æ¸…ç©ºç”»å¸ƒï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨åŠé€æ˜çŸ©å½¢è¦†ç›–ï¼Œåˆ¶é€ é•¿æ›å…‰æ•ˆæœ
        // æ£€æµ‹æ¨¡å¼
        let isDark = false;
        try {
            const bgColor = window.getComputedStyle(document.body).backgroundColor;
            const rgb = bgColor.match(/\d+/g);
            if (rgb) {
                const brightness = (parseInt(rgb[0])*299 + parseInt(rgb[1])*587 + parseInt(rgb[2])*114)/1000;
                isDark = brightness < 128;
            }
        } catch(e) { isDark = document.body.classList.contains('dark'); }

        // è¦†ç›–å±‚ï¼šé»‘å¤œç”¨é»‘ï¼Œç™½å¤©ç”¨ç™½ï¼Œæä½çš„ä¸é€æ˜åº¦ = æé•¿çš„æ‹–å°¾
        ctx.fillStyle = isDark ? 'rgba(5, 5, 5, 0.03)' : 'rgba(245, 245, 247, 0.05)';
        ctx.fillRect(0, 0, width, height);

        // 2. ç‰©ç†è®¡ç®— (Lorenz Equations)
        for(let i=0; i<SPEED; i++) {
            let dx = (sigma * (y - x)) * dt;
            let dy = (x * (rho - z) - y) * dt;
            let dz = (x * y - beta * z) * dt;
            x += dx;
            y += dy;
            z += dz;
            points.push({x, y, z});
            if (points.length > 2000) points.shift(); // é™åˆ¶ç‚¹æ•°ä¼˜åŒ–æ€§èƒ½
        }

        // 3. ç»˜åˆ¶
        ctx.beginPath();
        let first = true;
        
        // ç¼“æ…¢æ—‹è½¬è§†è§’
        angle += 0.002;
        const cosA = Math.cos(angle);
        const sinA = Math.sin(angle);

        for (let p of points) {
            // ç®€å•çš„ 3D æŠ•å½±å˜æ¢ (ç»• Y è½´æ—‹è½¬)
            // åŸå§‹ Lorenz çš„ Z è½´æœä¸Šï¼Œå¯¹åº”å±å¹•çš„ Y è½´å€’å½±
            let px = p.x * cosA - p.z * sinA;
            let pz = p.x * sinA + p.z * cosA; // æ·±åº¦
            let py = p.y;

            // æŠ•å½±åˆ° 2D å±å¹•
            let screenX = width / 2 + px * SCALE;
            let screenY = height / 2 + (py * SCALE) + 20; // +20 æ˜¯ä¸ºäº†å±…ä¸­

            if (first) {
                ctx.moveTo(screenX, screenY);
                first = false;
            } else {
                ctx.lineTo(screenX, screenY);
            }
        }

        // 4. ä¸Šè‰²
        if (isDark) {
            // é»‘å¤œï¼šéœ“è™¹æ¸å˜
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, `hsl(${colors.dark.hueStart}, 100%, 50%)`);
            gradient.addColorStop(1, `hsl(${colors.dark.hueEnd}, 100%, 50%)`);
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 1.5;
            ctx.shadowBlur = 10;
            ctx.shadowColor = `hsla(${colors.dark.hueStart}, 100%, 50%, 0.5)`;
        } else {
            // ç™½å¤©ï¼šé’¢ç¬”å¢¨æ°´ (æ·±è‰²)
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, `hsla(${colors.light.hueStart}, 80%, 30%, 0.6)`); // æ·±è“
            gradient.addColorStop(1, `hsla(${colors.light.hueEnd}, 80%, 30%, 0.6)`);   // æ·±çº¢
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 1.0; // ç™½å¤©çº¿æ¡æ›´ç»†
            ctx.shadowBlur = 0;
        }

        ctx.stroke();
        requestAnimationFrame(animate);
    }

    window.addEventListener('resize', resize);
    resize();
    animate();
})();
</script>