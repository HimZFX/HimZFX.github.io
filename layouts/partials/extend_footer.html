{{ partial "bg_core.html" . }}

<script>
window.BG_System.loadCassette({
    // --- ğŸŒŸ æ ¸å¿ƒæ•°æ® ---
    stars: [],
    angleOffset: 0,
    width: window.innerWidth,
    height: window.innerHeight,

    // --- âš™ï¸ ç‰©ç†å‚æ•° (å¯è°ƒæ•´) ---
    STAR_COUNT: 3,         // æ˜Ÿä½“æ•°é‡
    G: 0.5,                // å¼•åŠ›å¸¸æ•°
    SOFTENING: 100,       // è½¯åŒ–å› å­ (è¶Šå¤§è¿åŠ¨è¶Šå¹³æ»‘)
    TRAIL_LENGTH: 600,     // æ‹–å°¾é•¿åº¦
    FRICTION: 0.99999,     // é˜»å°¼ (æä½æ‘©æ“¦ï¼Œæ¥è¿‘çœŸç©º)
    CENTER_PULL: 0.00001, // å¾®å¼±å‘å¿ƒåŠ› (é˜²æ­¢é£æ•£å¤ªå¿«)
    ESCAPE_RADIUS: 2000,   // é€ƒé€¸åŠå¾„ (é£å‡ºå¤šè¿œé‡ç½®)
    
    // --- ğŸ¥ ç›¸æœºå‚æ•° ---
    ROTATION_SPEED: 0.001, // é•œå¤´æ—‹è½¬é€Ÿåº¦
    SCALE: 0.8,            // ç¼©æ”¾æ¯”ä¾‹
    Z_DEPTH: 800,          // æ™¯æ·±å› å­ (æ§åˆ¶è¿‘å¤§è¿œå°)

    // --- ğŸ¨ é¢œè‰²é…ç½® ---
    colors: {
        dark: [
            { color: '#00f2ff', glow: '#00f2ff' }, // é’
            { color: '#ff0055', glow: '#ff0055' }, // æ´‹çº¢
            { color: '#ffe600', glow: '#ffe600' }  // é‡‘
        ],
        light: [
            { color: '#003366', glow: 'transparent' }, // æ·±è“
            { color: '#800000', glow: 'transparent' }, // æ·±çº¢
            { color: '#2F4F4F', glow: 'transparent' }  // æ·±ç°
        ]
    },

    // --- ğŸ“¥ åˆå§‹åŒ–æ¥å£ ---
    onInit: function(w, h) {
        this.width = w;
        this.height = h;
        this.stars = [];
        // åˆ›å»ºåˆå§‹æ˜Ÿä½“
        for (let i = 0; i < this.STAR_COUNT; i++) {
            this.stars.push(this.createStar(i));
        }
    },

    // --- ğŸ“ çª—å£è°ƒæ•´æ¥å£ ---
    onResize: function(w, h) {
        this.width = w;
        this.height = h;
    },

    // --- ğŸ”„ ç‰©ç†æ›´æ–°æ¥å£ (æ¯å¸§è°ƒç”¨) ---
    onUpdate: function(isDark) {
        // 1. æ—‹è½¬é•œå¤´
        this.angleOffset += this.ROTATION_SPEED;

        // 2. ç‰©ç†è®¡ç®—
        for (let star of this.stars) {
            // A. Nä½“å¼•åŠ›
            for (let other of this.stars) {
                if (star === other) continue;
                const dx = other.x - star.x;
                const dy = other.y - star.y;
                const dz = other.z - star.z;
                const distSq = dx*dx + dy*dy + dz*dz;
                const dist = Math.sqrt(distSq);
                
                // F = G * m1 * m2 / r^2
                const force = (this.G * star.mass * other.mass) / (distSq + this.SOFTENING);
                
                star.vx += (force * dx / dist) / star.mass;
                star.vy += (force * dy / dist) / star.mass;
                star.vz += (force * dz / dist) / star.mass;
            }

            // B. ç¯å¢ƒåŠ› (å‘å¿ƒ + æ‘©æ“¦)
            star.vx += (0 - star.x) * this.CENTER_PULL;
            star.vy += (0 - star.y) * this.CENTER_PULL;
            star.vz += (0 - star.z) * this.CENTER_PULL;
            
            star.vx *= this.FRICTION;
            star.vy *= this.FRICTION;
            star.vz *= this.FRICTION;

            // C. æ›´æ–°ä½ç½®
            star.x += star.vx;
            star.y += star.vy;
            star.z += star.vz;

            // D. è¾¹ç•Œæ£€æŸ¥ (é£å‡ºé‡ç½®)
            const distSqFromCenter = star.x*star.x + star.y*star.y + star.z*star.z;
            if (distSqFromCenter > this.ESCAPE_RADIUS * this.ESCAPE_RADIUS) {
                this.resetStar(star);
                continue; // é‡ç½®åè·³è¿‡æœ¬æ¬¡è½¨è¿¹è®°å½•
            }

            // E. è®°å½•è½¨è¿¹
            star.history.push({x: star.x, y: star.y, z: star.z});
            if (star.history.length > this.TRAIL_LENGTH) star.history.shift();
        }
    },

    // --- ğŸ–Œï¸ æ¸²æŸ“æ¥å£ (æ¯å¸§è°ƒç”¨) ---
    onDraw: function(ctx, w, h, isDark) {
        const cx = w / 2;
        const cy = h / 2;
        
        // æŒ‰ç…§ Z è½´æ·±åº¦æ’åºï¼Œä¿è¯é®æŒ¡å…³ç³»æ­£ç¡® (é€‰åšï¼Œä¸ºäº†å®Œç¾)
        // this.stars.sort((a, b) => {
        //     const pA = this.project(a.x, a.y, a.z);
        //     const pB = this.project(b.x, b.y, b.z);
        //     return pA.zIndex - pB.zIndex;
        // });

        for (let star of this.stars) {
            const theme = isDark ? this.colors.dark : this.colors.light;
            const style = theme[star.index % theme.length];

            // 1. æŠ•å½±å½“å‰ä½ç½®
            const proj = this.project(star.x, star.y, star.z, cx, cy);
            const currentRadius = star.baseRadius * proj.scale;
            const baseAlpha = Math.max(0.2, Math.min(1.0, proj.scale));

            // 2. ç»˜åˆ¶æ¸å˜æ‹–å°¾
            // é‡‡æ ·ç‡ï¼šæ¯éš”2ä¸ªç‚¹ç”»ä¸€æ¬¡ï¼Œæå‡æ€§èƒ½
            const sampleRate = 2; 
            
            // æŠ€å·§ï¼šä¸ºäº†ç”»å‡ºæ¸å˜è‰²ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ®µä¸€æ®µåœ°ç”»
            // ä¸ºäº†é¿å… stroke() è°ƒç”¨è¿‡å¤šå½±å“æ€§èƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†æ‰¹æ¬¡ç”»æˆ–è€…åªç”»å…³é”®æ®µ
            // è¿™é‡Œä½¿ç”¨â€œå¾ªç¯ç»˜åˆ¶æ³•â€ä»¥ä¿è¯å®Œç¾çš„æ¸å˜æ•ˆæœ
            for (let i = 0; i < star.history.length - sampleRate; i += sampleRate) {
                const p3d1 = star.history[i];
                const p3d2 = star.history[i+sampleRate];
                
                const p1 = this.project(p3d1.x, p3d1.y, p3d1.z, cx, cy);
                const p2 = this.project(p3d2.x, p3d2.y, p3d2.z, cx, cy);
                
                const ratio = i / star.history.length; // 0 (å°¾) -> 1 (å¤´)
                
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                
                const finalAlpha = baseAlpha * ratio;
                
                if (isDark) {
                    // é»‘å¤œï¼šç™½è‰²å‘å…‰æ‹–å°¾
                    ctx.strokeStyle = `rgba(255, 255, 255, ${finalAlpha * 0.4})`;
                    ctx.lineWidth = ratio * 3 * p1.scale;
                } else {
                    // ç™½å¤©ï¼šé»‘è‰²æ·¡å¢¨æ‹–å°¾
                    ctx.strokeStyle = `rgba(0, 0, 0, ${finalAlpha * 0.15})`;
                    ctx.lineWidth = ratio * 2 * p1.scale;
                }
                
                ctx.lineCap = 'round';
                ctx.stroke();
            }

            // 3. ç»˜åˆ¶æ˜Ÿä½“ (åªåœ¨è§†é‡å‰æ–¹ç»˜åˆ¶)
            if (proj.scale > 0) {
                ctx.beginPath();
                ctx.arc(proj.x, proj.y, currentRadius, 0, Math.PI * 2);
                ctx.fillStyle = style.color;
                
                ctx.globalAlpha = baseAlpha;
                if (isDark) {
                    ctx.shadowBlur = 20 * proj.scale;
                    ctx.shadowColor = style.glow;
                }
                ctx.fill();
                
                // é‡ç½®çŠ¶æ€
                ctx.shadowBlur = 0;
                ctx.globalAlpha = 1.0;
            }
        }
    },

    // --- ğŸ› ï¸ å†…éƒ¨å·¥å…·å‡½æ•° ---

    // 3D æŠ•å½±ç®—æ³•
    project: function(x, y, z, cx, cy) {
        const cosA = Math.cos(this.angleOffset);
        const sinA = Math.sin(this.angleOffset);
        
        // ç»• Y è½´æ—‹è½¬
        const rotX = x * cosA - z * sinA;
        const rotZ = x * sinA + z * cosA;
        const rotY = y;

        // é€è§†é™¤æ³•
        let depthScale = this.Z_DEPTH / (this.Z_DEPTH + rotZ);
        depthScale = Math.max(0.1, Math.min(2.0, depthScale));

        const screenX = cx + rotX * this.SCALE * depthScale;
        const screenY = cy + rotY * this.SCALE * depthScale;

        return { x: screenX, y: screenY, scale: depthScale, zIndex: rotZ };
    },

    // åˆ›å»ºæ–°æ˜Ÿä½“å¯¹è±¡
    createStar: function(index) {
        const s = { index: index, history: [] };
        this.resetStar(s);
        return s;
    },

    // é‡ç½®æ˜Ÿä½“çŠ¶æ€
    resetStar: function(s) {
        // åœ¨å±å¹•ä¸­å¿ƒåŒºåŸŸéšæœºç”Ÿæˆ
        const spread = Math.min(this.width, this.height) * 0.75;
        
        s.x = (Math.random() - 0.5) * spread;
        s.y = (Math.random() - 0.5) * spread;
        s.z = (Math.random() - 0.5) * spread;
        
        s.vx = (Math.random() - 0.5) * 1.5;
        s.vy = (Math.random() - 0.5) * 1.5;
        s.vz = (Math.random() - 0.5) * 1.5;
        
        s.mass = 100 + Math.random() * 100;
        s.baseRadius = Math.sqrt(8 + s.mass/100);
        s.history = [];
        
        // é¢„å¡«å……å†å²è½¨è¿¹ï¼Œé¿å…é‡ç”Ÿæ—¶é—ªçƒ
        for(let i=0; i<this.TRAIL_LENGTH; i++) {
            s.history.push({x: s.x, y: s.y, z: s.z});
        }
    }
});
</script>